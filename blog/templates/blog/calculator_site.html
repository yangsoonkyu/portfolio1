<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>사칙연산 계산기</title>

    <style>
        * {
            box-sizing: border-box;
        }


        .disable-select {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .btn {

            display: block;
            border: 1px solid gray;
            text-align: center;
            padding-top: 14px;
            font-weight: bold;
            width: 50px;
            height: 50px;
            margin: 0 3px 3px 0;

        }

        .btn:hover {
            background-color: palevioletred;
        }

        #calc_body {
            margin: 0px;
            width: 220px;
            height: 310px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;


        }

        #calc_body ul {
            display: flex;
            padding-left: 0;
            justify-content: space-between;
            margin: 0px;
        }



        #screen,
        #screen2 {
            font-size: 1em;
            padding-top: 12px;
            padding-right: 12px;
            text-align: right;
            height: 55px;
            width: 218px;
            background-color: #31B0E5;
            color: white;
            margin-top: 0px;
            margin-bottom: 5px;
        }

        .miniScr1,
        .miniScr2 {
            display: inline-block;
            font-size: 1em;
            padding-top: 12px;
            padding-right: 12px;
            text-align: right;
            height: 55px;
            width: 106px;
            background-color: #31B0E5;
            color: white;
            margin-top: 0px;
            margin-bottom: 5px;
        }

        .miniScr3 {
            margin-left: 6px;
        }

        .miniScr3:hover,
        .miniScr1:hover {
            background-color: palevioletred;

        }


        .btnX2 {
            width: 106px;
        }

        .btnBgcolor {
            background-color: lightblue;
        }

        .c1 {
            border: 1px solid red;
            padding: 15px;
            width: 253px;
        }

        .btnX1 {
            width: 80px;
            height: 30px;
            padding-top: 2px;
            background-color: aqua;
            font-weight: 100;
        }


        #main {
            border: 1px solid gray;
            background-color: white;
            position: absolute;
            top: 160px;
            left: 580px;
        }

        .calcTxt{
            display: inline-block;
            position: absolute;
            top: 170px;
            left: 850px;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div>
        <img src="/static/images/계산기 배경.jpg" alt="">
    </div>

    <div class="c1" id="main">
        <p id="screen"></p>
        <p id="screen2"></p>
        <div id="calc_body">
            <ul>
                <li class="btn btnX1">Calc</li>
                <li class="btn btnX1">BMI</li>
                <li class="btn btnX1">㎡</li>
            </ul>
            <ul>
                <li class="btn">AC</li>
                <li class="btn">BS</li>
                <li class="btn">(</li>
                <li class="btn">)</li>
            </ul>
            <ul>
                <li class="btn btnBgcolor">7</li>
                <li class="btn btnBgcolor">8</li>
                <li class="btn btnBgcolor">9</li>
                <li class="btn">/</li>
            </ul>
            <ul>
                <li class="btn btnBgcolor">4</li>
                <li class="btn btnBgcolor">5</li>
                <li class="btn btnBgcolor">6</li>
                <li class="btn">*</li>
            </ul>
            <ul>
                <li class="btn btnBgcolor">1</li>
                <li class="btn btnBgcolor">2</li>
                <li class="btn btnBgcolor">3</li>
                <li class="btn">-</li>
            </ul>
            <ul>
                <li class="btn btnBgcolor btnX2">0</li>
                <li class="btn">=</li>
                <li class="btn">+</li>
            </ul>

        </div>

    </div>
    <div class="calcTxt"> 
        <img src="/static/images/계산기설명.jpg" alt="">
        
    </div>
    <script>


        // 계산기 이름 basicCalc
        // 텍스트 선택 차단 [버튼], [수식, 계산결과] 
        function initCalc() {
            // console.log("계산기를 준비합니다.");
            calcBase.body.addEventListener('click', getInput);
            window.addEventListener('keydown', shortCuts);
            var btns = document.querySelectorAll(".btn");
            for (var i = 0; i < btns.length; i++) {
                btns[i].classList.add('disable-select');
            }

            // 입력한 수식을 수정할 수 있도록 이벤트를 걸어둔다.
            calcBase.scr.addEventListener('click', editFn);

            // 소수점 자릿수 준비 
            //editLimit(n) << 자릿수를 15자리로 제한하는 함수에서 소수점을 포함한 자리제한을 위해 존재한다
            calcBase.deciLen = 5;

            
        }

        window.onload = function () {
            initCalc();
        };

        // 자료
        // 입력에서 전달 받은 키값을 보관한다.
        // 객체 생성 후 배열에 담아서 관리
        var calcBase = {
            data: [],
            data2: [],
            calcSign: "+-*/0123456789()",
            resetData: function () { 
                return this.data = [];
            },
            calcData: function () { // 데이타를 문자열로 합쳐서 수식계산결과를 보여줌
                try {
                    return eval(this.data.join(""));
                    
                } catch (error) {
                    return "에러"
                    
                }
                
            },
            removeLastInput: function () { // 한글자씩 지운다
                var target, len, item, itemLen;
                if (calcBase.type.length == 0 || calcBase.type[0] == "B" || calcBase.type[0] == "M" || calcBase.type[0] == "M2") {
                    target = this.data;
                } else if (calcBase.type[0] == "Bcm") {
                    target = this.data2;
                }
                len = target.length;
                item = target[len - 1];
                // data에서 마지막 아이템을 가져온다.
                try {
                    itemLen = item.length
                    
                } catch (error) {
                    return;
                    
                }
                
                // 아이템의 길이가 1보다 크면 한씩 지우고
                if (itemLen > 1) {
                    var str = item.slice(0, -1);
                    target[len - 1] = str;
                } else {
                    // 1이면 아이템을 삭제
                    target.pop();
                }
            },
            body: document.getElementById('calc_body'),
            deciLen: 0,
            scr: document.getElementById('screen'),
            type: [], //계산기의 타입(사칙연산계산기, BMI계산기, 평수계산기)을 담아둔다 
            keydown: [] // 입력방식이 키보드이면 값이 들어간다.
        }

        // 수식 수정
        function editFn(e) {
            var item, value, newValue, idx;
            item = e.target;
            value = item.innerText;
            // 노드를 확인
            if (item.nodeName === "SPAN") {
                idx = item.dataset.idx;
                newValue = prompt(value, calcBase.data[idx]);
                if (newValue === null) { //변경값이 입력되지 않으면 실행되지 않는다
                    return false;
                } else if (isCalcSign(newValue) === "string") { //기존 데이터와 수정될데이터의 타입을 비교하여 다르면 메세지 발생
                    return alert("문자는 입력할수 없습니다.")
                } else if (isCalcSign(value) === "number" && isCalcSign(newValue) !== "number") {
                    return alert("숫자를 입력해주세요");
                } else if (isCalcSign(value) === "sign" && isCalcSign(newValue) !== "sign") {
                    return alert("기호를 입력해주세요");
                } else if (isCalcSign(value) !== "bracket" && isCalcSign(value) !== isCalcSign(newValue)) {
                    return alert("잘못된 입력형식입니다.");
                }
                calcBase.data[idx] = newValue;
                showScreen();
            }
        }

        //키보드 이벤트 발생시 실행된다
        function shortCuts(e) { 
            calcBase.keydown.push("k")
            // 계산기의 입력방식을 알려주기위해 키다운배열에 값을 넣는다
            // console.log(e.key)
            if(window.event.keyCode == 9){ 
                event.returnValue = false ; // 실제 탭키의 이벤트 실행을 막는다.
                return myTab();}
            getInput(e);
        }

        function myTab(){
            if(calcBase.type[0]==="B"){ calcBase.type.unshift("Bcm")}
            else if(calcBase.type[0]==="Bcm"){calcBase.type.unshift("B")}
        }

        // 입력
        // 키값 입력을 가져온다.
        // 가져온 키값은 데이터에 전달한다.
        // 조건1 - 최초 입력시 기호의 경우 +, -, *, / 는 무시한다.
        // 조건2 - 숫자에 0으로 시작 방지.
        // 조건3 - 연산기호가 연속으로 입력되면 마지막 기호를 사용한다.
        // 조건4 - 15자리가 넘는 경우 무시 - 한번에 11자리까지 입력
        // 음수는 괄호를 사용한다.
        // 기호중 괄호는 연속입력이 가능하다.
        // 수정시 연산식으로 변경이 가능하며 배열에 담아 관리
        // 버튼을 클릭하면 화면에 보여주기
        // 연속되는 숫자 입력을 자릿수를 추가해 넣어준다.  예) 2,3,4 => 234
        function getInput(e) {
            var calcBtn, dataArr, getChar, lastItem, btns, dataArrLen;
            if(calcBase.type.length > 5){calcBase.type.pop()}
            btns = document.querySelectorAll(".btn");
            if (calcBase.keydown[0] === "k") { //입력방식이 키보드일때
                calcBase.keydown = [];
                getChar = e.key; //키보드의 입력값을 넣어준다.
                switch(getChar){ // 단축키 기정하는 부분
                    case "Escape": getChar = "AC"; break; 
                    case "Enter": getChar = "="; break; 
                    case "Backspace": getChar = "BS"; break; 
                }
                for (var i = 0; i < btns.length; i++) {
                    if (btns[i].innerText.indexOf(getChar) === 0) {
                        calcBtn = btns[i];
                    }
                }
            } else {
                calcBtn = e.target;
                getChar = calcBtn.innerText;
            }
            dataArr = calcBase.data;
            dataArrLen = dataArr.length;
            lastItem = dataArr[dataArrLen - 1];
            // 버튼이 아니면 이하 종료
            // 이벤트 타겟의 클래스네임에 btn이 없으면 종료된다.
            try {
                if (calcBtn.className.indexOf('btn') === -1) return;
            } catch (error) {
                return;
                
            }
            // (,),C,BS,1,2,3,4,5,6,7,8,9,+,-,*,/
            // 조건 - 최초 입력시 기호의 경우 *이거나, / 는 무시한다.
            if (!dataArrLen && isCalcSign(getChar) === "sign") return;

            // 조건 - 연산기호가 연속으로 입력되면 마지막 기호를 사용한다.
            // 배열의 마지막 입력 값과  현재 입력값이 모두 기호이면 치환한다.
            if (isCalcSign(lastItem) === "sign" && isCalcSign(getChar) === "sign") {
                // 치환
                dataArr[dataArrLen - 1] = getChar;
                showGetStr();
            } else if (Number.isInteger(parseInt(lastItem)) && Number.isInteger(parseInt(getChar)) && calcBase.type[0] !== "Bcm") {
                // 마직막에 data의 값이 숫자이고 입력한 값이 숫자이면
                // 값을 붙여준다. (["1","2","+","3"]이 아닌 ["12","+","3"] 으로 관리하기 위해서)
                var a = lastItem.concat(getChar);
                var num = 12;
                if(calcBase.type[0]==="B"){num = 5}
                
                if (dataArr[dataArrLen - 1].length < num) {
                    dataArr[dataArrLen - 1] = parseInt(a).toString();
                }
                showGetStr();
            }else if (Number.isInteger(parseInt(calcBase.data2[calcBase.data2.length-1])) && Number.isInteger(parseInt(getChar)) && calcBase.type[0] == "Bcm"){ 
                num = 5;
                if (calcBase.data2.length < num) {
                    calcBase.data2.push(getChar)
                }
                showGetStr();

            } else if (getChar === "=") {
                showScreen(); // 저장된 수식을 계산하고 화면에 보여준다.
            } else if (getChar === "AC") {
                if (calcBase.type.length == 0) {
                    calcBase.resetData();
                    showScreen();
                } else if (calcBase.type[0] == "B") {
                    calcBase.resetData();
                    myCalcBmi();
                } else if (calcBase.type[0] == "Bcm") {
                    calcBase.resetData();
                    calcBase.data2 = [];
                    calcBase.type = [];
                    calcBase.type.push("B")
                    myCalcBmi();
                } else if (calcBase.type[0] == "M") {
                    calcBase.resetData();
                    showScreen();
                } else if (calcBase.type[0] == "M2") {
                    calcBase.resetData();
                    showScreen();
                }
            } else if (getChar === "BS") {
                calcBase.removeLastInput(); // 마지막 입력 값을 삭제
                showGetStr(); // 저장된 수식을 계산하고 화면에 보여준다.
            } else if (getChar === "Calc") { 
                window.location.reload();
            } else if (getChar === "㎡") {
                myCalcM2();

            } else if (getChar === "BMI") {
                myCalcBmi();
            } else {
                if (calcBase.type[0] === "Bcm") {
                    if (isCalcSign(getChar) === "number") {
                        calcBase.data2.push(getChar);
                    }
                } else if (calcBase.type[0] === "B" && isCalcSign(getChar) !== "number") {
                    return
                } else if (calcBase.type[0] === "M" && isCalcSign(getChar) !== "number") {
                    return
                } else {
                    dataArr.push(getChar);
                }
                showGetStr();
            }

        }

        function myCalcM2() {
            var main = document.getElementById("main");
            var scr = document.getElementById("screen");
            var scr2 = document.getElementById("screen2");
            var mini1 = document.getElementById("miniScr1");
            var mini2 = document.getElementById("miniScr2");
            if (calcBase.type[0] === "B" || calcBase.type[0] === "Bcm") {
                calcBase.resetData();
                main.childNodes[0].remove();
                main.childNodes[0].remove();
                newScr = document.createElement("P")
                main.insertBefore(newScr, main.childNodes[0]);
                main.childNodes[0].id = "screen";
                scr = document.getElementById("screen");
                scr.innerText = "㎡";
                scr2.innerText = "평";
                calcBase.type.unshift("M")
            } else if (calcBase.type[0] === "M") { 
                calcBase.resetData();
                scr.innerText = "평";
                scr2.innerText = "㎡";
                calcBase.type.unshift("M2")

            } else if (calcBase.type[0] === "M2") {
                calcBase.resetData();
                scr.innerText = "㎡";
                scr2.innerText = "평";
                calcBase.type.unshift("M")

            } else {
                calcBase.resetData();
                scr.innerText = "㎡";
                scr2.innerText = "평";
                calcBase.type.unshift("M")

            }
        }

        function myCalcBmi() {
            var main = document.getElementById("main");
            var scr = document.getElementById("screen");
            var html1 = document.createElement("p");
            var html2 = document.createElement("p");
            if (calcBase.type.length === 0 || calcBase.type[0] === "M" || calcBase.type[0] === "M2") {
                main.removeChild(scr);
                calcBase.resetData();
                calcBase.data2 = [];
                showResult();
                main.insertBefore(html1, main.childNodes[0]);
                main.insertBefore(html2, main.childNodes[1]);
                main.childNodes[0].classList.add("miniScr1");
                main.childNodes[1].classList.add("miniScr2");
                main.childNodes[1].classList.add("miniScr3");
            }
            main.childNodes[0].innerText = "체중(kg)";
            main.childNodes[1].innerText = "키(cm)";
            calcBase.resetData();
            calcBase.data2 = [];
            calcBase.type.unshift("B");
            main.childNodes[1].addEventListener('click', bmiCm)
            main.childNodes[0].addEventListener('click', bmikg)

            showResult();
        }


        function bmiCm() {
            calcBase.type.unshift("Bcm")
        }

        function bmikg() {
            calcBase.type.unshift("B")
        }

        function isCalcSign(param) {
            var cSign = calcBase.calcSign.indexOf(param)

            if (cSign > -1 && cSign < 4) {
                return "sign"
            } else if (cSign >= 4 && cSign <= 13) {
                return "number"
            } else if (cSign > 13 && cSign < 16) {
                return "bracket"

            } else { return "string" }

        }


        // 출력
        // 자료의 값을 천단위로 화면에 출력
        // 연산으로 부터 전달 받은 계산 결과를 15자 이내로 출력
        // 입력값 선택이 가능하도록 수정 [마직막 작업]
        // 입력값에 천단위 기호 추가
        function showScreen() {
            showGetStr();
            // 계산을 위임
            // var n = evalStr();
            if (calcBase.type.length === 0) {
                showResult(calcBase.calcData());
            } else if (calcBase.type[0] === "B" || calcBase.type[0] === "Bcm") {
                var bkg = calcBase.data.join("");
                var bcm = (calcBase.data2.join("")) / 100;
                if (bcm === 0 || bkg === "") { return }
                var bResult = bkg / (bcm * bcm);

                showResult(bResult);

            }

        }

        function showGetStr() { 
            if (calcBase.type.length == 0) {
                // console.log("입력된 수식을 표현");
                var cArr = calcBase.data;
                var cStr = "";
                for (i in cArr) {
                    var x = parseInt(cArr[i]);
                    cStr += '<span data-idx=' + i + '>';
                    if (!isNaN(x)) {
                        cStr += addComma(cArr[i]);
                        cStr += '</span>';
                        continue;
                    }
                    cStr += cArr[i];
                    cStr += '</span>';
                }
                document.getElementById("screen").innerHTML = cStr;
            } else if (calcBase.type[0] === "B") {
                cArr = calcBase.data;
                cStr = "";
                for (i in cArr) {
                    cStr += cArr[i] + " kg";
                }
                if (cStr == "") { return document.getElementById("main").childNodes[0].innerText = "체중(kg)"; }
                document.getElementById("main").childNodes[0].innerText = cStr;
            } else if (calcBase.type[0] === "Bcm") {
                cArr = calcBase.data2;
                cStr = "";
                for (i in cArr) {
                    cStr += cArr[i];
                }
                cStr += " cm"
                if (cStr == "") { return document.getElementById("main").childNodes[1].innerText = "키(cm)"; }
                document.getElementById("main").childNodes[1].innerText = cStr;
            } else if (calcBase.type[0] === "M") {
                cArr = calcBase.data;
                cStr = "";
                for (i in cArr) {
                    cStr += cArr[i] + " ㎡";
                }
                if (cStr == "") {
                    document.getElementById("screen").innerText = "㎡";
                    return document.getElementById("screen2").innerText = "평";
                }
                document.getElementById("screen").innerText = cStr;
                showResult(cStr);

            } else if (calcBase.type[0] === "M2") {
                cArr = calcBase.data;
                cStr = "";
                for (i in cArr) {
                    cStr += cArr[i] + " 평";
                }
                if (cStr == "") {
                    document.getElementById("screen").innerText = "평";
                    return document.getElementById("screen2").innerText = "㎡";
                }
                document.getElementById("screen").innerText = cStr;
                showResult(cStr);
            }
        }

        function showResult(param) {
            // 결과를 화면에 뿌려주는 역할
            var bStr, resultSrt;
            // console.log("결과를 보여준다." + param);
            // 판단문 - 결과값 또는 초과 미만의 메세지를 처리
            if (param === undefined) {
                param = "";
            }else if(param === "에러"){
                return document.getElementById("screen2").innerHTML = "지원하지 않는 수식입니다";
            } else if (param > 999999999999 || param < -99999999999) {
                param = "결과가 범위를 초과하고 있습니다.";
            } else {
                if (calcBase.type.length === 0) {
                    param = editLimit(param);
                } else if (calcBase.type[0] === "B" || calcBase.type[0] === "Bcm") {
                    if (param < 18.5) {
                        bStr = "저체중";
                    } else if (param >= 18.5 && param <= 22.9) {
                        bStr = "정상";
                    } else {
                        bStr = "과체중";
                    }
                    calcBase.deciLen = 2; 
                    param = "BMI 수치는 " + editLimit(param) + "이므로 <br>" + bStr + "입니다.";
                } else if (calcBase.type[0] === "M") {

                    param = editLimit(parseInt(param) * 0.3025) + "평";
                } else if (calcBase.type[0] === "M2") {
                    param = editLimit(parseInt(param) * 3.305785) + "㎡";
                }

            }

            var num, commaStr, point, pStr = "";
            if (isNaN(param) || param === "") {
                commaStr = param;
            } else {
                // 부동소수점 계산 오류 발생  12345.123 - 12345 = 0.12299999999959255
                // int = parseInt(param);
                // commaStr = addComma(int);
                // point = param - int;
                // pStr = (point === 0)?"":point.toString().slice(1); // 삼항연산자
                num = String(param); // 12345.123
                point = num.indexOf('.'); // 소숫점의 인덱스값
                if (point < 0) {
                    commaStr = addComma(num); // 소수자리가 없는 경우
                } else {
                    pStr = num.slice(point); // 소수부분(소숫점 포함)
                    num = num.slice(0, point); // 정수부분
                    commaStr = addComma(num); // 천단위 쉽표 추가
                }
            }
            document.getElementById("screen2").innerHTML = commaStr + pStr;
        }

        function editLimit(n) {
            // n = 123456789.12345678
            // 쉽표를 포함한 15자리 이내 숫자로 돌려준다.
            // 너무 크거나 작은 수는 '결과가 너무 큽니다.' 또는 '결과가 너무 작습니다.'라는 메세지 전달.
            var valLen, commaLen, deciLen = calcBase.deciLen;
            // deciLen=5, n = 123456789.12345678, valLen = 9
            valLen = parseInt(n).toString().length;
            // 나머지가 0보다 크면 '몫'이 천다위 쉽표의 개수이다.
            // deciLen=5, n = 123456789.12345678, valLen = 9, commaLen = 3
            commaLen = parseInt(valLen / 3);
            if (valLen > 2 && valLen % 3 === 0) {
                // 나머지가 0이면 '몫-1'이 천단위 쉽표의 개수
                // deciLen=5, n = 123456789.12345678, valLen = 9, commaLen = 2
                commaLen--;
            }
            // deciLen=5, n = 123456789.12345678, valLen = 9, commaLen = 2, avaLen = 3
            var avaLen = 15 - valLen + commaLen - 1;
            if (deciLen > avaLen) deciLen = avaLen;
            // deciLen=3, n = 123456789.12345678, valLen = 9, commaLen = 2, avaLen = 3
            // 리턴값은 123456789.123   123.34000
            return Number(n.toFixed(deciLen));
        }

        function addComma(num) {
            // 정수를 입력받아 천단위마다 쉼표를 추가하는 역할
            if (isNaN(num)) return false;

            var str, result, l, len, sign = "";
            str = Math.abs(num).toString();
            len = str.length;
            l = len % 3;

            result = "";
            result += str.substr(0, l);

            while (l < len) {
                if (result !== "") result += ",";
                result += str.substr(l, 3);
                l += 3
            }
            if (num < 0) sign = "-";
            return sign + result;
        }



    </script>
</body>

</html>